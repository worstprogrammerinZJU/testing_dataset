# .github/workflows/test-arm64-with-export.yml
name: Test ARM64 Assembly (With Export)

on: [push, workflow_dispatch]

jobs:
  test-arm64-export:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        brew install coreutils
        which gtimeout
    
    - name: Test and export successful files
      run: |
        echo "=== ARM64 æ±‡ç¼–æµ‹è¯•ï¼ˆå¸¦å¯¼å‡ºåŠŸèƒ½ï¼‰==="
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p test_results/successful_files
        mkdir -p test_results/compiled_binaries
        
        TOTAL=0
        COMPILE_OK=0
        EXECUTE_OK=0
        SUCCESS_LIST=""
        
        for file in *.s; do
          if [ -f "$file" ]; then
            TOTAL=$((TOTAL + 1))
            NAME="${file%.s}"
            
            echo ""
            echo "æµ‹è¯•: $NAME"
            echo "========================================"
            
            # 1. ç¼–è¯‘
            echo "ç¼–è¯‘..."
            if clang "$file" -o "$NAME" 2>/tmp/compile_err; then
              COMPILE_OK=$((COMPILE_OK + 1))
              echo "âœ… ç¼–è¯‘æˆåŠŸ"
              
              # 2. åˆ†æç¨‹åºéœ€æ±‚
              echo "åˆ†æç¨‹åºéœ€æ±‚..."
              
              STRINGS=$(strings "$file" 2>/dev/null | grep -E '%[dfs]' || true)
              SCANF_CALLS=$(grep -c "bl.*scanf" "$file" 2>/dev/null || echo "0")
              
              echo "æ‰¾åˆ°æ ¼å¼å­—ç¬¦ä¸²: '$STRINGS'"
              echo "scanfè°ƒç”¨æ¬¡æ•°: $SCANF_CALLS"
              
              # ç”Ÿæˆæµ‹è¯•è¾“å…¥
              INPUT_DATA=""
              
              if [ "$SCANF_CALLS" -gt 0 ]; then
                if echo "$STRINGS" | grep -q "%d%d"; then
                  INPUT_DATA="1\n10 20\n"
                elif echo "$STRINGS" | grep -q "%d"; then
                  INPUT_DATA="1\n42\n"
                elif echo "$STRINGS" | grep -q "%s"; then
                  INPUT_DATA="test\n"
                elif echo "$STRINGS" | grep -q "%f"; then
                  INPUT_DATA="3.14\n"
                else
                  INPUT_DATA="1\n2 3\n4 5\n6 7\n8 9\n10 11\n"
                fi
              fi
              
              # 3. æ‰§è¡Œæµ‹è¯•
              echo "æ‰§è¡Œæµ‹è¯•..."
              
              if [ -z "$INPUT_DATA" ]; then
                # æ²¡æœ‰è¾“å…¥çš„ç¨‹åº
                if gtimeout 5 ./"$NAME" >/tmp/output 2>/tmp/error; then
                  EXIT_CODE=$?
                  EXECUTE_OK=$((EXECUTE_OK + 1))
                  echo "âœ… æ‰§è¡ŒæˆåŠŸ (é€€å‡ºç : $EXIT_CODE)"
                  
                  # è®°å½•æˆåŠŸæ–‡ä»¶
                  SUCCESS_LIST="${SUCCESS_LIST}${EXECUTE_OK}:${NAME}\n"
                  
                  # å¤åˆ¶æˆåŠŸæ–‡ä»¶
                  cp "$file" "test_results/successful_files/${EXECUTE_OK}_${NAME}.s"
                  cp "./$NAME" "test_results/compiled_binaries/${EXECUTE_OK}_${NAME}"
                  echo "ğŸ“ å·²ä¿å­˜: ${EXECUTE_OK}_${NAME}.s"
                  
                else
                  EXIT_CODE=$?
                  echo "âŒ æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
                fi
              else
                # æœ‰è¾“å…¥çš„ç¨‹åº
                if echo -e "$INPUT_DATA" | gtimeout 5 ./"$NAME" >/tmp/output 2>/tmp/error; then
                  EXIT_CODE=$?
                  EXECUTE_OK=$((EXECUTE_OK + 1))
                  echo "âœ… æ‰§è¡ŒæˆåŠŸ (é€€å‡ºç : $EXIT_CODE)"
                  
                  # è®°å½•æˆåŠŸæ–‡ä»¶
                  SUCCESS_LIST="${SUCCESS_LIST}${EXECUTE_OK}:${NAME}\n"
                  
                  # å¤åˆ¶æˆåŠŸæ–‡ä»¶
                  cp "$file" "test_results/successful_files/${EXECUTE_OK}_${NAME}.s"
                  cp "./$NAME" "test_results/compiled_binaries/${EXECUTE_OK}_${NAME}"
                  echo "ğŸ“ å·²ä¿å­˜: ${EXECUTE_OK}_${NAME}.s"
                  
                else
                  EXIT_CODE=$?
                  echo "âŒ æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
                fi
              fi
              
              # æ˜¾ç¤ºè¾“å‡º
              if [ -s /tmp/output ]; then
                echo "ç¨‹åºè¾“å‡º:"
                head -5 /tmp/output
              fi
              
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥"
            fi
          fi
        done
        
        # ç”ŸæˆæˆåŠŸæ–‡ä»¶åˆ—è¡¨
        echo -e "$SUCCESS_LIST" > test_results/success_list.txt
        
        # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        cat > test_results/test_report.md << EOF
# ARM64 æ±‡ç¼–æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•ç»Ÿè®¡
- æ€»æ–‡ä»¶æ•°: $TOTAL
- ç¼–è¯‘æˆåŠŸ: $COMPILE_OK
- æ‰§è¡ŒæˆåŠŸ: $EXECUTE_OK

## æˆåŠŸç‡
- ç¼–è¯‘æˆåŠŸç‡: $((COMPILE_OK * 100 / TOTAL))%
- æ‰§è¡ŒæˆåŠŸç‡: $((EXECUTE_OK * 100 / COMPILE_OK))%
- ç«¯åˆ°ç«¯æˆåŠŸç‡: $((EXECUTE_OK * 100 / TOTAL))%

## æˆåŠŸæ–‡ä»¶åˆ—è¡¨
EOF
        
        if [ -n "$SUCCESS_LIST" ]; then
          echo -e "$SUCCESS_LIST" | while IFS=: read -r num name; do
            if [ -n "$num" ]; then
              echo "- $num: $name" >> test_results/test_report.md
            fi
          done
        else
          echo "æ— æˆåŠŸæ–‡ä»¶" >> test_results/test_report.md
        fi
        
        cat >> test_results/test_report.md << EOF

## æ–‡ä»¶è¯´æ˜
- æˆåŠŸæ–‡ä»¶ä¿å­˜åœ¨: \`successful_files/\` ç›®å½•
- ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åœ¨: \`compiled_binaries/\` ç›®å½•
- æ–‡ä»¶å‘½åæ ¼å¼: \`ç¼–å·_åŸæ–‡ä»¶å.s\`

## ç¯å¢ƒä¿¡æ¯
- ç³»ç»Ÿ: macOS $(sw_vers -productVersion)
- ç¼–è¯‘å™¨: $(clang --version | head -1)
- æµ‹è¯•æ—¶é—´: $(date)
EOF
        
        echo ""
        echo "========================================"
        echo "æµ‹è¯•å®Œæˆ"
        echo "========================================"
        echo "æ€»æ–‡ä»¶æ•°: $TOTAL"
        echo "ç¼–è¯‘æˆåŠŸ: $COMPILE_OK"
        echo "æ‰§è¡ŒæˆåŠŸ: $EXECUTE_OK"
        echo ""
        echo "ğŸ“ æˆåŠŸæ–‡ä»¶å·²ä¿å­˜åˆ° test_results/"
        echo "ğŸ“‹ æˆåŠŸæ–‡ä»¶åˆ—è¡¨:"
        if [ -n "$SUCCESS_LIST" ]; then
          echo -e "$SUCCESS_LIST"
        else
          echo "æ— æˆåŠŸæ–‡ä»¶"
        fi
    
    - name: Upload successful files
      uses: actions/upload-artifact@v4
      with:
        name: successful-arm64-files
        path: |
          test_results/
        retention-days: 30
    
    - name: Upload individual artifacts
      uses: actions/upload-artifact@v4
      with:
        name: successful-sources
        path: test_results/successful_files/
        retention-days: 30
    
    - name: Upload compiled binaries
      uses: actions/upload-artifact@v4
      with:
        name: compiled-binaries
        path: test_results/compiled_binaries/
        retention-days: 30
    
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test_results/test_report.md
        retention-days: 30
