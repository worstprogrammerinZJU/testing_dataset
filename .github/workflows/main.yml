# .github/workflows/test-arm64-fixed.yml
name: Test ARM64 Assembly (Fixed Input Detection)

on: [push, workflow_dispatch]

jobs:
  test-arm64-fixed:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        brew install coreutils
        which gtimeout
    
    - name: Fixed test with better input detection
      run: |
        echo "=== ARM64 汇编测试（修复版）==="
        
        TOTAL=0
        COMPILE_OK=0
        EXECUTE_OK=0
        
        for file in *.s; do
          if [ -f "$file" ]; then
            TOTAL=$((TOTAL + 1))
            NAME="${file%.s}"
            
            echo ""
            echo "测试: $NAME"
            echo "========================================"
            
            # 1. 编译
            echo "编译..."
            if clang "$file" -o "$NAME" 2>/tmp/compile_err; then
              COMPILE_OK=$((COMPILE_OK + 1))
              echo "✅ 编译成功"
              
              # 2. 更智能的输入分析
              echo "分析程序需求..."
              
              # 方法1: 直接分析汇编中的字符串常量
              STRINGS=$(strings "$file" 2>/dev/null | grep -E '%[dfs]' || true)
              
              # 方法2: 查看汇编中的scanf调用
              SCANF_CALLS=$(grep -c "bl.*scanf" "$file" 2>/dev/null || echo "0")
              
              echo "找到格式字符串: '$STRINGS'"
              echo "scanf调用次数: $SCANF_CALLS"
              
              # 生成测试输入
              INPUT_DATA=""
              
              # 根据分析结果生成输入
              if [ "$SCANF_CALLS" -gt 0 ]; then
                if echo "$STRINGS" | grep -q "%d%d"; then
                  INPUT_DATA="10 20\n"
                  echo "检测到 %d%d 格式，使用: 10 20"
                elif echo "$STRINGS" | grep -q "%d"; then
                  INPUT_DATA="42\n"
                  echo "检测到 %d 格式，使用: 42"
                elif echo "$STRINGS" | grep -q "%s"; then
                  INPUT_DATA="test\n"
                  echo "检测到 %s 格式，使用: test"
                elif echo "$STRINGS" | grep -q "%f"; then
                  INPUT_DATA="3.14\n"
                  echo "检测到 %f 格式，使用: 3.14"
                else
                  # 默认输入
                  INPUT_DATA="1\n2 3\n4 5\n6 7\n8 9\n10 11\n"
                  echo "使用通用输入"
                fi
              else
                # 没有scanf调用，可能是纯计算程序
                INPUT_DATA=""
                echo "未检测到scanf调用，使用空输入"
              fi
              
              # 3. 执行测试
              echo "执行测试..."
              
              if [ -z "$INPUT_DATA" ]; then
                # 没有输入的程序
                if gtimeout 5 ./"$NAME" >/tmp/output 2>/tmp/error; then
                  EXIT_CODE=$?
                  EXECUTE_OK=$((EXECUTE_OK + 1))
                  echo "✅ 执行成功 (退出码: $EXIT_CODE)"
                else
                  EXIT_CODE=$?
                  echo "❌ 执行失败 (退出码: $EXIT_CODE)"
                fi
              else
                # 有输入的程序
                if echo -e "$INPUT_DATA" | gtimeout 5 ./"$NAME" >/tmp/output 2>/tmp/error; then
                  EXIT_CODE=$?
                  EXECUTE_OK=$((EXECUTE_OK + 1))
                  echo "✅ 执行成功 (退出码: $EXIT_CODE)"
                else
                  EXIT_CODE=$?
                  echo "❌ 执行失败 (退出码: $EXIT_CODE)"
                fi
              fi
              
              # 显示输出
              if [ -s /tmp/output ]; then
                echo "程序输出:"
                head -10 /tmp/output
              fi
              
              if [ -s /tmp/error ]; then
                echo "错误输出:"
                head -10 /tmp/error
              fi
              
            else
              echo "❌ 编译失败"
              if [ -s /tmp/compile_err ]; then
                echo "编译错误:"
                head -10 /tmp/compile_err
              fi
            fi
          fi
        done
        
        echo ""
        echo "========================================"
        echo "测试完成"
        echo "========================================"
        echo "总文件数: $TOTAL"
        echo "编译成功: $COMPILE_OK"
        echo "执行成功: $EXECUTE_OK"
        
        if [ $TOTAL -gt 0 ]; then
          COMPILE_RATE=$((COMPILE_OK * 100 / TOTAL))
          echo "编译成功率: $COMPILE_RATE%"
          
          if [ $COMPILE_OK -gt 0 ]; then
            EXECUTE_RATE=$((EXECUTE_OK * 100 / COMPILE_OK))
            echo "执行成功率: $EXECUTE_RATE%"
          fi
        fi
