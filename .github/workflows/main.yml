# .github/workflows/test-macos-arm64.yml
name: Test macOS ARM64 Assembly

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-macos-arm64:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "=== 环境信息 ==="
        uname -a
        clang --version
        sysctl -n machdep.cpu.brand_string
        echo "当前目录:"
        pwd
        ls -la *.s 2>/dev/null | head -10
    
    - name: Compile and test ARM64 assembly
      id: test
      run: |
        echo "=== 编译和测试 macOS ARM64 汇编 ==="
        
        COMPILE_SUCCESS=0
        COMPILE_TOTAL=0
        EXECUTE_SUCCESS=0
        EXECUTE_TOTAL=0
        
        # 查找所有 .s 文件
        ASM_FILES=$(find . -name "*.s" -type f | sort)
        echo "找到的汇编文件:"
        echo "$ASM_FILES"
        echo ""
        
        for asm_file in $ASM_FILES; do
          if [ -f "$asm_file" ]; then
            COMPILE_TOTAL=$((COMPILE_TOTAL + 1))
            filename=$(basename "$asm_file" .s)
            
            echo "测试: $filename"
            
            # 1. 编译（macOS 原生 ARM64）
            echo "编译: $asm_file"
            if clang "$asm_file" -o "$filename" 2>"${filename}_compile.log"; then
              echo "✅ 编译成功"
              COMPILE_SUCCESS=$((COMPILE_SUCCESS + 1))
              
              # 2. 执行（macOS 原生执行）
              echo "执行: $filename"
              if timeout 10s ./"$filename" < /dev/null >"${filename}_output.log" 2>"${filename}_error.log"; then
                echo "✅ 执行成功"
                EXECUTE_SUCCESS=$((EXECUTE_SUCCESS + 1))
                
                # 显示程序输出
                if [ -s "${filename}_output.log" ]; then
                  echo "输出: $(head -c 100 "${filename}_output.log")..."
                fi
              else
                EXIT_CODE=$?
                echo "❌ 执行失败 (退出码: $EXIT_CODE)"
                if [ -s "${filename}_error.log" ]; then
                  echo "错误: $(head -c 200 "${filename}_error.log")"
                fi
              fi
            else
              echo "❌ 编译失败"
              if [ -s "${filename}_compile.log" ]; then
                echo "编译错误: $(head -c 200 "${filename}_compile.log")"
              fi
            fi
            echo ""
          fi
        done
        
        # 计算成功率
        if [ $COMPILE_TOTAL -gt 0 ]; then
          COMPILE_RATE=$((COMPILE_SUCCESS * 100 / COMPILE_TOTAL))
        else
          COMPILE_RATE=0
        fi
        
        if [ $EXECUTE_SUCCESS -gt 0 ]; then
          EXECUTE_RATE=$((EXECUTE_SUCCESS * 100 / COMPILE_SUCCESS))
        else
          EXECUTE_RATE=0
        fi
        
        echo "=== 最终结果 ==="
        echo "编译: $COMPILE_SUCCESS/$COMPILE_TOTAL ($COMPILE_RATE%)"
        echo "执行: $EXECUTE_SUCCESS/$COMPILE_SUCCESS ($EXECUTE_RATE%)"
        
        # 保存结果
        echo "compile_success=$COMPILE_SUCCESS" >> $GITHUB_OUTPUT
        echo "compile_total=$COMPILE_TOTAL" >> $GITHUB_OUTPUT
        echo "execute_success=$EXECUTE_SUCCESS" >> $GITHUB_OUTPUT
