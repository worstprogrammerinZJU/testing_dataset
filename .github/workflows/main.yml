# .github/workflows/test-arm64-keep-name.yml
name: Test ARM64 Assembly (Keep Original Names)

on: [push, workflow_dispatch]

jobs:
  test-arm64-keep-name:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        brew install coreutils
    
    - name: Test and save with original names
      run: |
        echo "=== ARM64 æ±‡ç¼–æµ‹è¯•ï¼ˆä¿ç•™åŸæ–‡ä»¶åï¼‰==="
        
        # åˆ›å»ºæˆåŠŸæ–‡ä»¶ç›®å½•
        mkdir -p successful_files
        
        TOTAL=0
        COMPILE_SUCCESS=0
        EXECUTE_SUCCESS=0
        
        for file in *.s; do
          if [ -f "$file" ]; then
            TOTAL=$((TOTAL + 1))
            NAME="${file%.s}"
            
            echo "æµ‹è¯•: $file"
            echo "----------------------------------------"
            
            # ç¼–è¯‘
            if clang "$file" -o "$NAME" 2>/dev/null; then
              COMPILE_SUCCESS=$((COMPILE_SUCCESS + 1))
              echo "âœ… ç¼–è¯‘æˆåŠŸ"
              
              # æ‰§è¡Œæµ‹è¯•
              if echo -e "1\n2 3" | timeout 3 ./"$NAME" >/dev/null 2>&1; then
                EXECUTE_SUCCESS=$((EXECUTE_SUCCESS + 1))
                echo "âœ… æ‰§è¡ŒæˆåŠŸ"
                
                # ä¿å­˜æ–‡ä»¶ï¼ˆä¿ç•™åŸæ–‡ä»¶åï¼‰
                cp "$file" "successful_files/$file"
                echo "ğŸ“ å·²ä¿å­˜: $file"
              else
                echo "âŒ æ‰§è¡Œå¤±è´¥"
              fi
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥"
            fi
            echo ""
          fi
        done
        
        echo "========================================"
        echo "æµ‹è¯•å®Œæˆ"
        echo "========================================"
        
        if [ $TOTAL -gt 0 ]; then
          # è®¡ç®—ç¼–è¯‘æˆåŠŸç‡
          COMPILE_RATE=$(echo "scale=2; $COMPILE_SUCCESS * 100 / $TOTAL" | bc)
          
          # è®¡ç®—æ‰§è¡ŒæˆåŠŸç‡ï¼ˆåŸºäºç¼–è¯‘æˆåŠŸçš„æ–‡ä»¶ï¼‰
          if [ $COMPILE_SUCCESS -gt 0 ]; then
            EXECUTE_RATE=$(echo "scale=2; $EXECUTE_SUCCESS * 100 / $COMPILE_SUCCESS" | bc)
          else
            EXECUTE_RATE=0
          fi
          
          # è®¡ç®—æ€»ä½“æˆåŠŸç‡
          OVERALL_RATE=$(echo "scale=2; $EXECUTE_SUCCESS * 100 / $TOTAL" | bc)
          
          echo "ğŸ“Š ç»Ÿè®¡ç»“æœ:"
          echo "ğŸ“ æµ‹è¯•æ–‡ä»¶æ€»æ•°: $TOTAL"
          echo "âœ… ç¼–è¯‘æˆåŠŸ: $COMPILE_SUCCESS/$TOTAL ($COMPILE_RATE%)"
          echo "ğŸš€ æ‰§è¡ŒæˆåŠŸ: $EXECUTE_SUCCESS/$COMPILE_SUCCESS ($EXECUTE_RATE%)"
          echo "ğŸ¯ æ€»ä½“æˆåŠŸç‡: $EXECUTE_SUCCESS/$TOTAL ($OVERALL_RATE%)"
          
          echo "========================================"
          echo "ğŸ“ ä¿å­˜çš„æˆåŠŸæ–‡ä»¶ ($EXECUTE_SUCCESS ä¸ª):"
          if [ -d "successful_files" ] && [ "$(ls -A successful_files/ 2>/dev/null)" ]; then
            ls -la successful_files/
          else
            echo "æ— æˆåŠŸæ–‡ä»¶"
          fi
        else
          echo "âš ï¸  æœªæ‰¾åˆ° .s æ–‡ä»¶"
        fi
    
    - name: Upload successful files
      uses: actions/upload-artifact@v4
      with:
        name: successful-arm64-files
        path: successful_files/
        retention-days: 30
